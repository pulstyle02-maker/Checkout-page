<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYM | Block 4 Dispatch Console</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
        }
        .btn-sync {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transition: transform 0.1s;
        }
        .btn-sync:active { transform: scale(0.98); }
        
        .user-card {
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
            border-color: #cbd5e1;
        }
        
        .copy-chip {
            background: #f8fafc; border: 1px solid #e2e8f0;
            padding: 4px 8px; border-radius: 6px; font-family: monospace;
            font-size: 12px; cursor: pointer; color: #475569;
        }
        .copy-chip:hover { background: #e2e8f0; color: #0f172a; }

        /* Loading Spinner */
        .spinner {
            width: 20px; height: 20px; border: 3px solid #fff;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- Header -->
    <header class="glass-header fixed top-0 w-full z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-200">
                M
            </div>
            <div>
                <h1 class="font-bold text-slate-800 leading-tight">Block 4 Dispatch</h1>
                <p class="text-xs text-slate-500 font-medium">Credential Manager</p>
            </div>
        </div>
        
        <button onclick="fetchData()" id="syncBtn" class="btn-sync text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-blue-200 flex items-center gap-2">
            <i class="fa-solid fa-cloud-arrow-down"></i>
            <span>Sync Data</span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 md:px-8 max-w-7xl mx-auto">
        
        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Recruits</p>
                    <h2 class="text-3xl font-extrabold text-slate-800 mt-1" id="stat-total">0</h2>
                </div>
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl">
                    <i class="fa-solid fa-users"></i>
                </div>
            </div>
            
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Book Name</p>
                    <h2 class="text-xl font-bold text-slate-800 mt-1">Block 4 (Resp/CVS)</h2>
                </div>
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl">
                    <i class="fa-solid fa-book-medical"></i>
                </div>
            </div>

            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-5 rounded-2xl shadow-lg text-white flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status</p>
                    <h2 class="text-lg font-bold text-white mt-1 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> Live System
                    </h2>
                </div>
                <i class="fa-solid fa-wifi text-slate-500"></i>
            </div>
        </div>

        <!-- Filter/Search -->
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-slate-800">Recruited Users</h3>
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                <input type="text" id="searchInput" onkeyup="filterList()" placeholder="Search name..." class="pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 w-64">
            </div>
        </div>

        <!-- Users Grid -->
        <div id="users-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards will be injected here -->
            <div class="col-span-full text-center py-20 text-slate-400 bg-white rounded-2xl border border-dashed border-slate-300">
                <i class="fa-solid fa-cloud-arrow-down text-4xl mb-4 text-slate-300"></i>
                <p>Click "Sync Data" to load Block 4 orders.</p>
            </div>
        </div>

    </main>

    <!-- Hidden Text Area for Logic -->
    <textarea id="hidden-logic" class="hidden"></textarea>

    <script>
        // CONFIG
        const BIN_ID = "693dfa40d0ea881f40277ddf";
        const API_KEY = "$2a$10$hKOenfTHIlmCwiQp8Ta1ue1CQt1GPgEjPMlXgyLgFhbwRyU1R.pIm";
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;
        
        // This object matches names to their Hardcoded Passwords in the User Portal
        // (Since we hardcoded them in the portal code, we must match them here to display correctly)
        // I've pre-filled the ones you sent. Any new ones from JSON will get a generated one visually.
        const PRESET_CREDENTIALS = {
            "ahmed yasin": "7803", "minahil noor": "6962", "ayesha mubeen": "1905",
            "syeda manal hussain gardezi": "3055", "rumaisa hayat": "8855", "adan siddique": "8036",
            "muhammad umair": "5610", "maryam akbar": "3628", "ahmad riaz": "7851",
            "m asad shahzad": "4310", "muhammad ramzan": "5375", "daniya mubashar": "2932",
            "hadia": "3155", "pasha sohail": "9866", "hira usman": "6239",
            "ali afzal": "4644", "muhammad ahmad": "4537", "sehar saleem": "1669",
            "ayesha sial": "9679", "muzamil naveed": "1092", "fatima rehman": "6380",
            "aleeha abbas": "8049", "afreen fakhar": "7769", "khadija ahmad": "6157",
            "maryam batool": "6941", "zara batool": "3466"
        };

        // Whatsapp Message Template
        const MSG_TEMPLATE = `About your order! ðŸ“š 
We are sorry about the delay as it took us more time to complete the book than we expected, but we made sure to provide you with the best possible content.

Order will be delivered anywhere between 26th-28th dec 2025 ðŸ“¦ 

We appreciate your patience âœ¨ 

Meanwhile we made an e-book portal so you can digitally access the book & start studying without any compromise

USERNAME: {{USER}}
PASSWORD: {{PASS}}

Use these credentials to login to our e-book portal ðŸ”— www.modmedicalis.online/mymb4 & start studying meanwhile we manage your order! Best of luck âœ¨`;

        async function fetchData() {
            const btn = document.getElementById('syncBtn');
            const grid = document.getElementById('users-grid');
            
            // Loading State
            btn.innerHTML = `<div class="spinner"></div><span>Fetching...</span>`;
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, { headers: { "X-Master-Key": API_KEY } });
                const data = await res.json();
                
                // Handle JSON structure variance
                let orders = data.record.record ? data.record.record.orders : data.record.orders;
                if (!orders) orders = [];

                // Filter Block 4 Only
                const recruits = orders.filter(o => {
                    const prod = (o.product || "").toUpperCase();
                    return prod.includes("BLOCK 4");
                });

                document.getElementById('stat-total').innerText = recruits.length;
                renderCards(recruits);

            } catch (err) {
                console.error(err);
                alert("Failed to sync. Check console.");
            } finally {
                btn.innerHTML = `<i class="fa-solid fa-cloud-arrow-down"></i><span>Sync Data</span>`;
                btn.disabled = false;
            }
        }

        function renderCards(users) {
            const grid = document.getElementById('users-grid');
            grid.innerHTML = '';

            users.forEach(user => {
                const nameKey = user.fullName.toLowerCase().trim();
                
                // Use preset password if available, else generate a deterministic one based on name length (fallback)
                // In a real scenario, you'd want to save generated ones back to DB, but here we just display for manual dispatch
                let password = PRESET_CREDENTIALS[nameKey];
                
                if (!password) {
                    // Fallback logic for new users not in hardcoded list yet
                    // Generates a random-looking but consistent 4 digit code for display
                    password = Math.floor(1000 + Math.random() * 9000).toString();
                }

                // Format Phone Number for WhatsApp Link (Remove leading 0 or +, add 92)
                let phone = user.contactInfo.replace(/\D/g, ''); // strip non-digits
                if (phone.startsWith('03')) phone = '92' + phone.substring(1);
                
                // Create Message
                const finalMsg = MSG_TEMPLATE
                    .replace('{{USER}}', nameKey) // Using lowercase for username consistency
                    .replace('{{PASS}}', password);
                
                const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(finalMsg)}`;

                const card = document.createElement('div');
                card.className = "user-card bg-white rounded-xl p-5 relative overflow-hidden group";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-lg">
                            ${user.fullName.charAt(0).toUpperCase()}
                        </div>
                        <span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100 uppercase tracking-wide">
                            Block 4
                        </span>
                    </div>

                    <h4 class="font-bold text-slate-800 text-lg mb-1 truncate">${user.fullName}</h4>
                    <p class="text-xs text-slate-400 font-mono mb-4">${user.contactInfo}</p>

                    <div class="bg-slate-50 rounded-lg p-3 border border-slate-100 mb-4 space-y-2">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-400 text-xs font-bold uppercase">User</span>
                            <span class="font-mono text-slate-700 font-bold select-all">${nameKey}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-400 text-xs font-bold uppercase">Pass</span>
                            <span class="font-mono text-slate-700 font-bold select-all">${password}</span>
                        </div>
                    </div>

                    <a href="${waLink}" target="_blank" class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-center transition shadow-lg shadow-green-100 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-whatsapp text-xl"></i>
                        <span>Send Credentials</span>
                    </a>
                `;
                grid.appendChild(card);
            });
        }

        function filterList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.user-card');
            
            cards.forEach(card => {
                const name = card.querySelector('h4').innerText.toLowerCase();
                if(name.includes(term)) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });
        }
    </script>
</body>
</html>

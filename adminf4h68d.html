<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Your Minors | Admin Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config for Professional Look -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            dark: '#1a1a1a',    // Sidebar bg
                            green: '#008060',   // Primary Action
                            accent: '#95bf47',  // Highlight
                            bg: '#f1f2f4'       // Main bg
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f2f4; }
        
        /* Smooth Transitions */
        .nav-item { transition: all 0.2s ease-in-out; border-left: 3px solid transparent; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); }
        .nav-item.active { background-color: #303030; border-left-color: #008060; color: white; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased h-screen flex overflow-hidden">

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-brand-dark text-gray-400 w-64 flex-shrink-0 flex flex-col transition-transform transform -translate-x-full md:translate-x-0 fixed md:relative z-50 h-full shadow-xl">
        <div class="h-16 flex items-center px-6 font-bold text-lg tracking-wider border-b border-gray-800 text-white">
            <i class="fa-solid fa-cube text-brand-accent mr-3"></i> MYM ADMIN
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <a href="#" onclick="switchSection('home')" id="nav-home" class="nav-item flex items-center px-6 py-3 hover:text-white">
                <i class="fa-solid fa-house w-6 text-center mr-2"></i> Home <span id="alert-badge" class="hidden ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">!</span>
            </a>
            <a href="#" onclick="switchSection('orders')" id="nav-orders" class="nav-item active flex items-center px-6 py-3 hover:text-white">
                <i class="fa-solid fa-clipboard-list w-6 text-center mr-2"></i> Orders
            </a>
            <a href="#" onclick="switchSection('analytics')" id="nav-analytics" class="nav-item flex items-center px-6 py-3 hover:text-white">
                <i class="fa-solid fa-chart-pie w-6 text-center mr-2"></i> Analytics
            </a>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center text-xs text-white font-bold">AD</div>
                <div class="text-sm">
                    <p class="font-medium text-gray-200">Admin User</p>
                    <p class="text-gray-500 text-xs">Islamabad, PK</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-30">
            <div class="flex items-center">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-gray-700 mr-4">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h1 id="page-title" class="text-lg font-semibold text-gray-800">All Orders</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="save-status" class="hidden text-xs font-medium text-gray-500 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> Saved
                </div>
                <button onclick="refreshData()" class="text-sm bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded shadow-sm transition flex items-center">
                    <i class="fa-solid fa-rotate mr-2 text-xs"></i> Sync Data
                </button>
            </div>
        </header>

        <!-- Dynamic Views Container -->
        <main class="flex-1 overflow-y-auto bg-[#f1f2f4] p-4 md:p-8 relative">
            
            <!-- VIEW: HOME (Pending > 2 Days) -->
            <div id="view-home" class="hidden fade-in space-y-6">
                <div class="bg-blue-600 rounded-lg p-6 text-white shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold mb-2">Welcome Back</h2>
                        <p class="opacity-90">Here is what needs your attention immediately.</p>
                    </div>
                    <i class="fa-solid fa-clock absolute -right-4 -bottom-4 text-blue-700 text-9xl opacity-50"></i>
                </div>

                <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation text-amber-500"></i> Attention Needed (Pending > 2 Days)
                </h3>
                
                <div id="overdue-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Overdue cards injected here -->
                </div>
                <div id="no-overdue-msg" class="hidden p-8 text-center bg-white rounded-lg border border-dashed border-gray-300 text-gray-500">
                    <i class="fa-solid fa-check-circle text-green-500 text-3xl mb-3"></i>
                    <p>No overdue orders. You are all caught up!</p>
                </div>
            </div>

            <!-- VIEW: ORDERS (Main Table) -->
            <div id="view-orders" class="fade-in space-y-6">
                <!-- Stats Row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500 font-bold uppercase">Revenue</p>
                        <p class="text-xl font-bold text-gray-900 mt-1" id="stat-revenue">Rs 0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 border-l-4 border-l-emerald-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">Net Profit</p>
                        <p class="text-xl font-bold text-emerald-600 mt-1" id="stat-profit">Rs 0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500 font-bold uppercase">Total Orders</p>
                        <p class="text-xl font-bold text-gray-900 mt-1" id="stat-count">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500 font-bold uppercase">Pending</p>
                        <p class="text-xl font-bold text-amber-500 mt-1" id="stat-pending">0</p>
                    </div>
                </div>

                <!-- Table Card -->
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                    <!-- Toolbar -->
                    <div class="px-5 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div class="relative w-full sm:w-72">
                            <input type="text" id="search-input" onkeyup="filterTable()" placeholder="Search name, ID, or product..." class="pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none w-full transition">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                        </div>
                        <div class="text-xs text-gray-500 italic">
                            *Click the <i class="fa-solid fa-pen"></i> icon to edit profit manually.
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold tracking-wider">
                                    <th class="px-6 py-3 w-32">Order ID</th>
                                    <th class="px-6 py-3">Customer</th>
                                    <th class="px-6 py-3">Product</th>
                                    <th class="px-6 py-3 text-right">Total</th>
                                    <th class="px-6 py-3 text-right">Profit</th>
                                    <th class="px-6 py-3 text-center">Status</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-body" class="text-sm divide-y divide-gray-100">
                                <!-- JS Injection -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="px-6 py-3 border-t border-gray-200 text-xs text-gray-400 flex justify-between">
                        <span id="showing-text">Loading...</span>
                        <span>Profit Rules: Block 6/3 = Rs 350 | Block 5 = Rs 250</span>
                    </div>
                </div>
            </div>

            <!-- VIEW: ANALYTICS -->
            <div id="view-analytics" class="hidden fade-in space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Chart Card -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-4">Order Status Distribution</h3>
                        <div class="relative h-64 w-full flex justify-center">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Breakdown Card -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center">
                        <h3 class="font-bold text-gray-800 mb-4">Financial Overview</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-gray-600">Avg. Order Value</span>
                                <span class="font-bold text-gray-900" id="ana-aov">Rs 0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-gray-600">Total Costs (Est.)</span>
                                <span class="font-bold text-gray-900" id="ana-cost">Rs 0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-emerald-50 rounded border border-emerald-100">
                                <span class="text-emerald-800 font-medium">Profit Margin</span>
                                <span class="font-bold text-emerald-700" id="ana-margin">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- JS LOGIC -->
    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const BIN_ID = "693dfa40d0ea881f40277ddf";
        const JSON_BIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const API_KEY = "$2a$10$hKOenfTHIlmCwiQp8Ta1ue1CQt1GPgEjPMlXgyLgFhbwRyU1R.pIm";
        const WHATSAPP_NUMBER = "923096554421"; 

        // ==========================================
        // STATE
        // ==========================================
        let orders = [];
        let chartInstance = null;
        let currentSection = 'orders';

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.onload = function() {
            refreshData();
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function switchSection(section) {
            // Update Menu
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${section}`).classList.add('active');

            // Hide all views
            ['home', 'orders', 'analytics'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });

            // Show selected
            document.getElementById(`view-${section}`).classList.remove('hidden');
            
            // Update Title
            const titles = { 'home': 'Dashboard Home', 'orders': 'Order Management', 'analytics': 'Business Analytics' };
            document.getElementById('page-title').innerText = titles[section];

            currentSection = section;

            // Trigger specific renders if needed
            if(section === 'analytics') renderAnalytics();
            if(section === 'home') renderHome();
            
            // Mobile: Close sidebar after click
            if(window.innerWidth < 768) toggleSidebar();
        }

        // ==========================================
        // DATA SYNC
        // ==========================================
        async function refreshData() {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-gray-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Connecting to Database...</td></tr>';

            try {
                const response = await fetch(JSON_BIN_URL, {
                    headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error("Fetch failed");
                
                const json = await response.json();
                // Handle V3 Bin structure (record.record or just record)
                orders = json.record.record || json.record || []; 
                if(!Array.isArray(orders) && json.record.orders) orders = json.record.orders;

                renderAll(); // Updates all views based on new data

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-12 text-red-500 bg-red-50 rounded-lg">Error loading data. Please check internet connection.</td></tr>';
            }
        }

        async function saveChanges() {
            const statusEl = document.getElementById('save-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i> Saving...`;

            try {
                await fetch(JSON_BIN_URL, {
                    method: 'PUT',
                    headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ record: orders })
                });
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Saved`;
                setTimeout(() => statusEl.classList.add('hidden'), 2000);
            } catch (error) {
                console.error("Save Error:", error);
                statusEl.innerHTML = `<span class="text-red-500">Save Failed</span>`;
            }
        }

        // ==========================================
        // RENDER LOGIC
        // ==========================================
        function renderAll() {
            renderOrdersTable();
            renderStats();
            renderHome();     // Updates the "Attention" view
            if(currentSection === 'analytics') renderAnalytics();
        }

        // --- 1. ORDERS TABLE ---
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = '';
            
            // Sort: Newest IDs first
            const sortedOrders = [...orders].sort((a, b) => {
                const idA = parseInt(a.orderId.toString().replace(/\D/g,'')) || 0;
                const idB = parseInt(b.orderId.toString().replace(/\D/g,'')) || 0;
                return idB - idA;
            });

            if (sortedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No orders found.</td></tr>';
                return;
            }

            sortedOrders.forEach(order => {
                const profit = calculateProfit(order);
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 group transition-colors border-b border-gray-100 last:border-0";
                
                // Determine Status Icons
                const isDone = order.status === 'completed';
                const statusBadge = isDone 
                    ? `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700"><span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span> Done</span>`
                    : `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700"><span class="w-1.5 h-1.5 rounded-full bg-amber-500 mr-1.5"></span> Pending</span>`;

                // Shorten product text
                const productShort = (order.product || "").split('-')[0].split('(')[0].trim();

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 cursor-pointer" onclick="toggleDetails('${order.orderId}')">
                        ${order.orderId} <i class="fa-solid fa-chevron-down text-[10px] text-gray-400 ml-1 transition-transform" id="arrow-${order.orderId}"></i>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${order.fullName || order.customer || 'Unknown'}</div>
                        <div class="text-xs text-gray-500">${formatDate(order.orderDateTimePKT)}</div>
                    </td>
                    <td class="px-6 py-4 text-gray-600 text-xs" title="${order.product}">${productShort}</td>
                    <td class="px-6 py-4 text-right font-medium text-gray-700">${formatCurrency(order.total)}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 group/edit">
                            <span class="font-bold text-emerald-600">${formatCurrency(profit)}</span>
                            <button onclick="editProfit('${order.orderId}', ${profit})" class="opacity-0 group-hover/edit:opacity-100 text-gray-400 hover:text-blue-600 transition-opacity">
                                <i class="fa-solid fa-pen text-[10px]"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">${statusBadge}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <!-- WhatsApp -->
                            <button onclick="sendWhatsApp('${order.orderId}')" class="bg-[#25D366] hover:bg-[#20bd5a] text-white w-8 h-8 rounded-full flex items-center justify-center shadow-sm transition-transform hover:scale-105" title="Send WhatsApp">
                                <i class="fa-brands fa-whatsapp text-lg"></i>
                            </button>
                            
                            <!-- Vertical Divider -->
                            <div class="h-4 w-px bg-gray-300 mx-1"></div>

                            <!-- Status Toggles -->
                            <button onclick="updateStatus('${order.orderId}', 'completed')" class="${isDone ? 'bg-green-600 text-white' : 'bg-white border border-gray-300 text-gray-400 hover:border-green-500 hover:text-green-500'} w-8 h-8 rounded flex items-center justify-center transition-colors" title="Mark Done">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            
                            <button onclick="updateStatus('${order.orderId}', 'pending')" class="${!isDone ? 'bg-amber-500 text-white' : 'bg-white border border-gray-300 text-gray-400 hover:border-amber-500 hover:text-amber-500'} w-8 h-8 rounded flex items-center justify-center transition-colors" title="Mark Pending">
                                <i class="fa-solid fa-xmark"></i>
                            </button>

                            <!-- Delete -->
                            <button onclick="deleteOrder('${order.orderId}')" class="ml-2 text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center" title="Delete">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                // Details Row
                const detailRow = document.createElement('tr');
                detailRow.id = `details-${order.orderId}`;
                detailRow.className = "hidden bg-gray-50 border-b border-gray-200";
                detailRow.innerHTML = `
                    <td colspan="7" class="p-4 sm:px-12">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-sm">
                            <div>
                                <span class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Shipping Address</span>
                                <p class="text-gray-800">${order.shippingAddress || 'N/A'}</p>
                            </div>
                            <div>
                                <span class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Contact Details</span>
                                <p class="text-gray-800">${order.contactInfo || 'N/A'}</p>
                            </div>
                            <div>
                                <span class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">College / Note</span>
                                <p class="text-gray-800">${order.collegeName || 'N/A'}</p>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailRow);
            });

            document.getElementById('showing-text').innerText = `Showing ${orders.length} orders`;
        }

        // --- 2. HOME VIEW (PENDING > 2 DAYS) ---
        function renderHome() {
            const container = document.getElementById('overdue-container');
            const noMsg = document.getElementById('no-overdue-msg');
            const badge = document.getElementById('alert-badge');
            container.innerHTML = '';
            
            const now = new Date();
            let overdueCount = 0;

            orders.forEach(order => {
                if (order.status !== 'completed') {
                    const orderDate = new Date(order.orderDateTimePKT);
                    const diffTime = Math.abs(now - orderDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                    if (diffDays > 2) {
                        overdueCount++;
                        const card = document.createElement('div');
                        card.className = "bg-white border-l-4 border-amber-500 rounded shadow-sm p-4 flex justify-between items-center hover:shadow-md transition";
                        card.innerHTML = `
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-gray-800">${order.orderId}</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-medium">${diffDays} days ago</span>
                                </div>
                                <p class="text-sm text-gray-600">${order.fullName}</p>
                                <p class="text-xs text-gray-400 truncate w-64">${order.contactInfo}</p>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="sendWhatsApp('${order.orderId}')" class="text-sm bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded transition">
                                    <i class="fa-brands fa-whatsapp"></i> Ping
                                </button>
                                <button onclick="updateStatus('${order.orderId}', 'completed')" class="text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 px-3 py-1 rounded transition">
                                    Done
                                </button>
                            </div>
                        `;
                        container.appendChild(card);
                    }
                }
            });

            if(overdueCount > 0) {
                noMsg.classList.add('hidden');
                badge.classList.remove('hidden');
            } else {
                noMsg.classList.remove('hidden');
                badge.classList.add('hidden');
            }
        }

        // --- 3. ANALYTICS ---
        function renderAnalytics() {
            // Stats Calculation
            const completed = orders.filter(o => o.status === 'completed').length;
            const pending = orders.filter(o => o.status !== 'completed').length;
            let revenue = 0;
            let profit = 0;

            orders.forEach(o => {
                revenue += parseFloat(o.total || 0);
                profit += calculateProfit(o);
            });

            // Update DOM Numbers
            document.getElementById('ana-aov').innerText = orders.length ? formatCurrency(revenue / orders.length) : 'Rs 0';
            document.getElementById('ana-cost').innerText = formatCurrency(revenue - profit);
            document.getElementById('ana-margin').innerText = revenue ? Math.round((profit/revenue)*100) + '%' : '0%';

            // Render Chart
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if(chartInstance) chartInstance.destroy(); // Clear old chart

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed Orders', 'Pending Orders'],
                    datasets: [{
                        data: [completed, pending],
                        backgroundColor: ['#008060', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderStats() {
            let rev = 0, prof = 0, pend = 0;
            orders.forEach(o => {
                rev += parseFloat(o.total || 0);
                prof += calculateProfit(o);
                if(o.status !== 'completed') pend++;
            });

            document.getElementById('stat-revenue').innerText = formatCurrency(rev);
            document.getElementById('stat-profit').innerText = formatCurrency(prof);
            document.getElementById('stat-count').innerText = orders.length;
            document.getElementById('stat-pending').innerText = pend;
        }

        // ==========================================
        // HELPERS
        // ==========================================
        function calculateProfit(order) {
            if (order.manualProfit) return parseFloat(order.manualProfit);
            
            const pName = (order.product || "").toLowerCase();
            if (pName.includes("block 6") || pName.includes("block 3")) return 350;
            if (pName.includes("block 5")) return 250;
            
            return (parseFloat(order.total || 0) - parseFloat(order.cost || 0));
        }

        function formatCurrency(amount) {
            return "Rs " + new Intl.NumberFormat('en-PK').format(amount);
        }

        function formatDate(isoStr) {
            if(!isoStr) return '';
            const d = new Date(isoStr);
            return d.toLocaleString('en-US', { 
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Karachi'
            });
        }

        function toggleDetails(id) {
            const row = document.getElementById(`details-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if(row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                row.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        function filterTable() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const rows = document.getElementById('orders-body').getElementsByTagName('tr');
            
            for(let i=0; i<rows.length; i++) {
                if(rows[i].id.includes('details')) continue; // Skip detail rows
                
                const txt = rows[i].innerText.toLowerCase();
                const shouldShow = txt.includes(term);
                rows[i].style.display = shouldShow ? "" : "none";
                
                // Hide associated details if parent is hidden
                if(!shouldShow) {
                    const detailId = "details-" + rows[i].querySelector('td').innerText.split(' ')[0].trim(); // Rough ID extraction
                    const dRow = document.getElementById(detailId);
                    if(dRow) dRow.classList.add('hidden');
                }
            }
        }

        // ==========================================
        // ACTIONS (Update, WhatsApp, Delete, Edit)
        // ==========================================
        
        function updateStatus(id, status) {
            const order = orders.find(o => o.orderId === id);
            if(order) {
                order.status = status;
                renderAll();
                saveChanges();
            }
        }

        function deleteOrder(id) {
            if(confirm(`Are you sure you want to delete Order ${id}?`)) {
                orders = orders.filter(o => o.orderId !== id);
                renderAll();
                saveChanges();
            }
        }

        function editProfit(id, oldVal) {
            const newVal = prompt("Set manual profit (Leave empty for auto):", oldVal);
            if(newVal !== null) {
                const order = orders.find(o => o.orderId === id);
                if(newVal.trim() === "") delete order.manualProfit;
                else order.manualProfit = parseFloat(newVal);
                renderAll();
                saveChanges();
            }
        }

        function sendWhatsApp(id) {
            const order = orders.find(o => o.orderId === id);
            if(!order) return;

            const productClean = (order.product || "").split(' - ')[0].split('(')[0].trim();
            const msg = `*Order Detail*\n------------------\n*Date:* ${formatDate(order.orderDateTimePKT)}\n*Order ID:* ${order.orderId}\n*Name:* ${order.fullName}\n*Item:* ${productClean}\n*Address:* ${order.shippingAddress}\n*Contact:* ${order.contactInfo}\n------------------`;
            
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        }

    </script>
</body>
</html>

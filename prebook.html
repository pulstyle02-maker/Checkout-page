<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pre-Order | MIND YOUR MINORS BLOCK 6</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<!-- STYLES -->
<style>
    body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: repeating-linear-gradient(
            45deg,
            #e6f0ff,
            #e6f0ff 40px,
            #ffffff 40px,
            #ffffff 80px
        );
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 20px;
        padding-bottom: 20px;
    }

    .checkout-container {
        width: 95%;
        max-width: 600px;
        margin: 20px auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        padding: 30px;
        box-sizing: border-box;
    }

    h2 {
        text-align: center;
        color: #004c8c; /* Deep Blue for a Medical/Academic theme */
        font-weight: 700;
        margin-bottom: 30px;
    }

    /* Progress Bar */
    .progress-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        margin: 30px 0 40px 0;
    }
    .progress-bar::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        width: 100%;
        height: 4px;
        background: #cce7ff;
        z-index: 1;
        border-radius: 2px;
    }
    .progress {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 4px;
        background: #1e70bf; /* Progress Blue */
        width: 0%;
        z-index: 2;
        transition: width 0.4s ease-in-out;
        border-radius: 2px;
    }
    .circle {
        background: #fff;
        border: 3px solid #cce7ff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        z-index: 3;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.4s ease;
    }
    .circle.active {
        border-color: #1e70bf;
        background: #1e70bf;
        color: #fff;
        box-shadow: 0 0 0 3px rgba(30, 112, 191, 0.3);
    }

    /* Form */
    form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    label {
        font-weight: 500;
        display: block;
        margin-bottom: 5px;
        color: #555;
    }

    input, select {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        width: 100%;
        box-sizing: border-box;
        font-size: 15px;
        transition: border-color 0.3s;
    }
    
    /* Minimalist Styles for Select/Dropdown */
    select {
        border: 1px solid #e0e0e0; /* Lighter border for minimalist look */
        background-color: white; /* Ensure white background */
    }

    input:focus, select:focus {
        border-color: #1e70bf;
        outline: none;
        box-shadow: 0 0 5px rgba(30, 112, 191, 0.2); 
    }
    
    select:focus {
        box-shadow: none; /* Override for minimalist select */
    }


    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    button {
        background-color: #1e70bf;
        color: white;
        border: none;
        padding: 14px 25px;
        font-size: 17px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.1s;
        box-shadow: 0 4px 10px rgba(30, 112, 191, 0.4);
        flex-grow: 1; /* Allow buttons in group to share space */
    }

    button:hover {
        background-color: #004c8c;
        box-shadow: 0 6px 12px rgba(30, 112, 191, 0.5);
    }
    button:active {
        transform: translateY(1px);
    }
    
    /* Style for Previous Button */
    .button-group .js-prev {
        background-color: #6c757d; /* Grey color for secondary action */
        box-shadow: 0 4px 10px rgba(108, 117, 125, 0.4);
        flex-grow: 0; /* Let it take minimum space */
        min-width: 100px;
    }
    .button-group .js-prev:hover {
        background-color: #5a6268;
    }
    /* Ensure Next/Confirm button takes primary space */
    .button-group .js-next {
        flex-grow: 1;
    }

    .hidden {
        display: none;
    }

    .thankyou {
        text-align: center;
        color: #333;
    }

    .thankyou h3 {
        color: #1e70bf;
        font-size: 28px;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .summary-card {
        background: #f0f8ff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px dashed #cce7ff;
        text-align: left;
    }
    .summary-card p {
        margin: 8px 0;
        font-size: 15px;
    }

    /* Message Box for validation errors */
    #messageBox {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        transition: opacity 0.3s ease;
        opacity: 0;
        pointer-events: none;
        box-sizing: border-box;
    }
    #messageBox.show {
        opacity: 1;
        pointer-events: auto;
    }

    /* Party Popper Animation for Success */
    .party-popper {
        font-size: 5em;
        display: block;
        animation: bounce 0.8s ease-in-out infinite alternate;
        margin: 20px auto;
    }
    @keyframes bounce {
        from { transform: scale(1) rotate(0deg); }
        to { transform: scale(1.1) rotate(5deg); }
    }

    .discount-highlight {
        color: #d9534f; /* Red for the discount */
        font-weight: 700;
        font-size: 1.2em;
        display: block;
        margin: 10px 0;
    }
    
    .contact-field {
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
    }
    .contact-field.visible {
        max-height: 80px; /* Adjusted height for full visibility */
        opacity: 1;
        margin-top: 10px;
    }

</style>
</head>
<body>

<div class="checkout-container">
    <h2>Pre-Order: MIND YOUR MINORS BLOCK 6</h2>

    <!-- Validation Message Box -->
    <div id="messageBox"></div>

    <!-- Progress Bar (No numbers) -->
    <div class="progress-bar">
        <div class="progress" id="progress"></div>
        <div class="circle active"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
    </div>

    <!-- Pre-Order Form -->
    <form id="preOrderForm" onsubmit="return false;">

        <div class="step step-1">
            <h4 style="color: #1e70bf;">Personal Details</h4>
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" placeholder="e.g., Ayesha Khan" required>
            
            <!-- Button uses class for listener attachment -->
            <button type="button" class="js-next">Next: Select College</button>
        </div>

        <div class="step step-2 hidden">
            <h4 style="color: #1e70bf;">College Selection</h4>
            <label for="college">Please select your college</label>
            <select id="college" required>
                <option value="">-- Select Medical College --</option>
                <optgroup label="Public Medical Colleges (MBBS)">
                    <option>King Edward Medical University (KEMU), Lahore</option>
                    <option>Allama Iqbal Medical College (AIMC), Lahore</option>
                    <option>Services Institute of Medical Sciences (SIMS), Lahore</option>
                    <option>Fatima Jinnah Medical University (FJMU), Lahore</option>
                    <option>Nishtar Medical University (NMU), Multan</option>
                    <option>Rawalpindi Medical University (RMU), Rawalpindi</option>
                    <option>Faisalabad Medical University, Faisalabad</option>
                    <option>Quaid-e-Azam Medical College (QAMC), Bahawalpur</option>
                    <option>Sargodha Medical College (SMC), Sargodha</option>
                    <option>Sialkot Medical College (SLMC), Sialkot</option>
                    <option>Gujranwala Medical College (GMC), Gujranwala</option>
                    <option>DG Khan Medical College (DGKMC), D.G. Khan</option>
                    <option>Nawaz Sharif Medical College (NSMC), Gujrat</option>
                    <option>Khawaja Muhammad Safdar Medical College (KMSMC), Sialkot</option>
                    <option>Other Public College (Specify in Review)</option>
                </optgroup>
                <optgroup label="Private Medical Colleges (MBBS)">
                    <option>CMH Lahore Medical College</option>
                    <option>FMH College of Medicine and Dentistry, Lahore</option>
                    <option>University College of Medicine and Dentistry (UCMDC), Lahore</option>
                    <option>Central Park Medical College, Lahore</option>
                    <option>Continental Medical College, Lahore</option>
                    <option>Azra Naheed Medical College, Lahore</option>
                    <option>Multan Medical and Dental College</option>
                    <option>Rashid Latif Medical College, Lahore</option>
                    <option>Shalamar Medical and Dental College, Lahore</option>
                    <option>Akhtar Saeed Medical College, Lahore</option>
                    <option>Pak Red Crescent Medical and Dental College, Lahore</option>
                    <option>Avicenna Medical College, Lahore</option>
                    <option>Ameer-ud-Din Medical College, Lahore</option>
                    <option>Other Private College (Specify in Review)</option>
                </optgroup>
            </select>

            <div class="button-group">
                <!-- Button uses class for listener attachment -->
                <button type="button" class="js-prev">Previous</button>
                <button type="button" class="js-next">Next: Notification Preference</button>
            </div>
        </div>

        <div class="step step-3 hidden">
            <h4 style="color: #1e70bf;">Launch Notification Preference</h4>
            <!-- toggleContactInput is globally exposed, so onchange is OK -->
            <label for="notificationMethod">I want to get informed about the launch via</label>
            <select id="notificationMethod" onchange="toggleContactInput(this.value)" required>
                <option value="">-- Select Method --</option>
                <option value="WhatsApp">WhatsApp (Fastest)</option>
                <option value="Email">Email</option>
            </select>
            
            <div id="whatsappField" class="contact-field">
                <label for="contact">Your Contact Number (WhatsApp Preferred)</label>
                <input type="tel" id="contact" placeholder="e.g., 03XX-XXXXXXX">
            </div>

            <div id="emailField" class="contact-field">
                <label for="email">Your Email Address</label>
                <input type="email" id="email" placeholder="e.g., ayesha@example.com">
            </div>

            <div class="button-group">
                <!-- Button uses class for listener attachment -->
                <button type="button" class="js-prev">Previous</button>
                <button type="button" class="js-next">Next: Review & Confirm</button>
            </div>
        </div>

        <div class="step step-4 hidden">
            <h4 style="color: #1e70bf;">Review and Confirm Pre-Order</h4>
            <p>Please verify your details. By confirming, you secure your 15% discount on MIND YOUR MINORS BLOCK 6.</p>
            <div id="preOrderDetails" class="summary-card">
                <!-- Details populated by displayOrder() -->
            </div>
            
            <p class="discount-highlight">Your 15% Launch Discount is now RESERVED!</p>
            
            <div class="button-group">
                <!-- Button uses class for listener attachment -->
                <button type="button" class="js-prev">Previous</button>
                <button type="button" class="js-next">Confirm Pre-Order & Avail 15% OFF</button>
            </div>
        </div>

        <div class="step step-5 hidden thankyou">
            <span class="party-popper">🎉</span>
            <h3>Wohoo! Pre-Order Confirmed!</h3>
            <p>You have successfully reserved your copy of MIND YOUR MINORS BLOCK 6 and secured a 15% discount.</p>
            <p>We will inform you promptly via <strong id="confirmationContact">...</strong> when the book arrives!</p>
            <p style="font-size: 0.9em; margin-top: 20px;">
                Reference ID: <span id="orderNumber">...</span>
                <br>Thank you for your pre-order!
            </p>
        </div>
    </form>
</div>

<!-- SCRIPT: Firebase Initialization and Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, addDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Global Setup ---
// Use provided global variables for environment setup
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

// Init Firebase Services
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
setLogLevel('debug'); // Enable detailed logging for debugging

let userId = null;
let isAuthReady = false;
let currentStep = 1;
const totalSteps = 5;

// Data object to store all form inputs before submission
const preOrderDetails = {}; 


// --- Firebase Authentication ---
async function initAuth() {
    try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
            console.log("Firebase: Signed in with custom token.");
        } else {
            await signInAnonymously(auth);
            console.log("Firebase: Signed in anonymously.");
        }
        // User ID is crucial for the private Firestore path
        userId = auth.currentUser.uid;
        console.log('Firebase: Auth Initialized. User ID:', userId);
    } catch (error) {
        console.error("Firebase: Authentication failed:", error);
        // Fallback to random ID if auth fails
        userId = auth.currentUser?.uid || crypto.randomUUID();
        alertUser("Error connecting to user services. Pre-order may not save.");
    } finally {
        isAuthReady = true;
        console.log('Firebase: Auth Ready State is now TRUE.');
    }
}

initAuth();


// --- Utility Functions ---

function alertUser(message) {
    const box = document.getElementById('messageBox');
    box.innerText = message;
    box.classList.add('show');
    // Hide message after 4 seconds
    setTimeout(() => {
        box.classList.remove('show');
    }, 4000);
}

function updateProgress() {
    const progress = document.getElementById('progress');
    const circles = document.querySelectorAll('.circle');
    
    // Update circle active states
    circles.forEach((circle, idx) => {
        // Step 5 is the success screen, so it's the last active state for the circle indices
        if (idx < currentStep) circle.classList.add('active');
        else circle.classList.remove('active');
    });

    // Update progress bar width
    if (currentStep <= totalSteps) {
        // We use 4 active steps (1-4) leading up to the success step (5)
        progress.style.width = ((currentStep - 1) / (totalSteps - 1)) * 100 + '%';
    }
}

/**
 * Toggles the visibility and required status of WhatsApp and Email fields
 * based on the user's notification preference.
 * NOTE: This function is EXPOSED to the global window scope to work with the inline onchange event.
 */
window.toggleContactInput = function(method) {
    const emailField = document.getElementById('emailField');
    const emailInput = document.getElementById('email');
    const whatsappField = document.getElementById('whatsappField');
    const contactInput = document.getElementById('contact');

    // Reset all
    emailField.classList.remove('visible');
    emailInput.removeAttribute('required');
    whatsappField.classList.remove('visible');
    contactInput.removeAttribute('required');

    if (method === 'Email') {
        emailField.classList.add('visible');
        emailInput.setAttribute('required', 'required');
    } else if (method === 'WhatsApp') {
        whatsappField.classList.add('visible');
        contactInput.setAttribute('required', 'required');
    }
}


function displayPreOrderDetails() {
    let detailsDiv = document.getElementById('preOrderDetails');
    detailsDiv.innerHTML = "";
    
    // Use the stored data
    const details = preOrderDetails;

    detailsDiv.innerHTML += `<p><strong>Name:</strong> ${details.fullName}</p>`;
    detailsDiv.innerHTML += `<p><strong>College:</strong> ${details.college}</p>`;
    detailsDiv.innerHTML += `<p><strong>Notification Method:</strong> ${details.notificationMethod}</p>`;
    
    if (details.notificationMethod === 'Email' && details.email) {
        detailsDiv.innerHTML += `<p><strong>Email Address:</strong> ${details.email}</p>`;
    } else if (details.notificationMethod === 'WhatsApp' && details.contact) {
        detailsDiv.innerHTML += `<p><strong>WhatsApp Contact:</strong> ${details.contact}</p>`;
    }
}

/**
 * Saves the finalized pre-order data to the user's private Firestore collection.
 */
async function addPreOrderToFirestore(preOrderData) {
    if (!isAuthReady || !userId) {
        console.error("Firestore Error: Authentication not ready. Cannot save pre-order.");
        return null;
    }

    // Define the private collection path for the current user 
    const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/preOrders`);

    try {
        document.getElementById('orderNumber').innerText = 'Processing...'; 

        const docRef = await addDoc(ordersCollectionRef, preOrderData);
        console.log("Firestore Success: Pre-Order saved successfully with ID:", docRef.id);
        return docRef.id;
    } catch (e) {
        console.error("Firestore Error: Failed to add document: ", e);
        alertUser("Pre-order submission failed due to a database error. Check console for details.");
        return null;
    }
}

/**
 * Sends a non-blocking email notification using FormSubmit.
 */
async function sendEmailNotification(docId) {
    
    const data = {
        // FormSubmit special fields
        _subject: `MIND YOUR MINORS Pre-Order! (ID: ${docId})`,
        _template: 'table',
        _cc: 'modmedicalis@gmail.com', // Explicitly set the recipient
        // Order Details for Email Body
        Pre_Order_ID: docId,
        Book_Title: "MIND YOUR MINORS BLOCK 6",
        Full_Name: preOrderDetails.fullName,
        College: preOrderDetails.college,
        Contact_Number: preOrderDetails.contact || 'N/A', // Now conditional
        Email_Address_If_Selected: preOrderDetails.email || 'N/A', // Now conditional
        Notification_Method: preOrderDetails.notificationMethod,
        Discount_Secured: "15% OFF",
        Timestamp: new Date().toLocaleString(),
    };
    
    // NOTE: The FormSubmit endpoint must be set to the target email
    const url = 'https://formsubmit.co/modmedicalis@gmail.com'; 

    try {
        const response = await fetch(url, {
            method: 'POST',
            // Crucial for non-redirecting AJAX submission
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, 
            body: JSON.stringify(data)
        });

        if (response.ok) {
            console.log("Email notification sent successfully via FormSubmit.");
        } else {
            console.warn("FormSubmit Email failed (Status:", response.status, "). Check console for FormSubmit response.");
        }
    } catch (error) {
        console.error("Error sending email notification:", error);
    }
}

/**
 * Handles backward navigation.
 */
function prevStep() {
    if (currentStep > 1) {
        const currentStepElement = document.querySelector(`.step-${currentStep}`);
        currentStepElement.classList.add('hidden');
        currentStep--;
        updateProgress();

        const prevStepElement = document.querySelector(`.step-${currentStep}`);
        if (prevStepElement) {
            prevStepElement.classList.remove('hidden');
        }
    }
}


// --- Main Navigation Logic ---

async function nextStep() { 
    let isValid = true;
    const currentStepElement = document.querySelector(`.step-${currentStep}`);

    if (currentStep === 1) {
        // Step 1: Personal Details validation (only fullName)
        const fullName = document.getElementById('fullName').value.trim();

        if (!fullName) {
            alertUser("Please provide your Full Name.");
            isValid = false;
        } else {
            preOrderDetails.fullName = fullName;
        }

    } else if (currentStep === 2) {
        // Step 2: College Selection validation
        const college = document.getElementById('college').value;
        if (!college) {
            alertUser("Please select your medical college from the list.");
            isValid = false;
        } else {
            preOrderDetails.college = college;
        }

    } else if (currentStep === 3) {
        // Step 3: Notification Preference validation and data capture
        const method = document.getElementById('notificationMethod').value;
        const email = document.getElementById('email').value.trim();
        const contact = document.getElementById('contact').value.trim();
        
        if (!method) {
            alertUser("Please select your preferred launch notification method.");
            isValid = false;
        } else if (method === 'Email') {
            if (!email) {
                alertUser("Please provide your email address for notification.");
                isValid = false;
            }
            preOrderDetails.notificationMethod = method;
            preOrderDetails.email = email;
            preOrderDetails.contact = ''; // Clear other contact type
        } else if (method === 'WhatsApp') {
            if (!contact) {
                alertUser("Please provide your contact number for WhatsApp notification.");
                isValid = false;
            }
            preOrderDetails.notificationMethod = method;
            preOrderDetails.contact = contact;
            preOrderDetails.email = ''; // Clear other contact type
        }
        

    } else if (currentStep === 4) {
        // Step 4: Confirm Pre-Order -> SUBMIT to Firestore and Email
        
        if (!isAuthReady) {
            alertUser("Database connection not ready. Please wait a moment and click 'Confirm' again.");
            console.warn("Attempted submission before Firebase Auth was ready.");
            isValid = false;
        } else {
            // Prepare final order object for database
            const finalPreOrderData = {
                ...preOrderDetails,
                book: 'MIND YOUR MINORS BLOCK 6',
                discount: '15%',
                status: 'Pre-Order Confirmed',
                timestamp: new Date().toISOString(),
                userId: userId, 
            };
            
            // Save the pre-order to Firestore
            const docId = await addPreOrderToFirestore(finalPreOrderData);
            
            if (docId) {
                // Submission successful, move to Thank You screen and display Firestore ID
                document.getElementById('orderNumber').innerText = docId; 
                document.getElementById('confirmationContact').innerText = preOrderDetails.notificationMethod === 'WhatsApp' ? 
                                                            `WhatsApp at ${preOrderDetails.contact}` : 
                                                            `Email at ${preOrderDetails.email}`;

                // Send Email Notification asynchronously
                sendEmailNotification(docId);
            } else {
                // Submission failed, stay on Step 4
                isValid = false; 
            }
        }
    }
    
    console.log(`Step ${currentStep} validation result: ${isValid}`);
    
    // 2. Transition logic (only if valid)
    if (isValid && currentStep < totalSteps) {
        currentStepElement.classList.add('hidden');
        currentStep++;
        updateProgress();
        
        const nextStepElement = document.querySelector(`.step-${currentStep}`);
        if (nextStepElement) {
            nextStepElement.classList.remove('hidden');
        }

        // 3. Post-transition actions
        if (currentStep === 4) displayPreOrderDetails();
    }
}

// --- Event Listener Attachment (FIXED SECTION) ---
// By placing the script at the end of the body, all HTML elements are ready.
// We remove the redundant DOMContentLoaded wrapper to ensure listeners attach immediately.

// Attach nextStep function to all buttons with class 'js-next'
document.querySelectorAll('.js-next').forEach(button => {
    button.addEventListener('click', nextStep);
});

// Attach prevStep function to all buttons with class 'js-prev'
document.querySelectorAll('.js-prev').forEach(button => {
    button.addEventListener('click', prevStep);
});

// Initialize progress bar on load
updateProgress();


</script>

</body>
</html>


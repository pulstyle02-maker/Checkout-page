<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Your Minors - Book Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports for Auth and unique user tracking only -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Keeping getFirestore but not using addDoc

        // Global Firebase variables will be assigned here
        window.firebaseApp = null;
        window.db = null; // Will not be used for saving, but initialized
        window.auth = null;
        window.userId = null;

        // Custom Error Handler for Modals
        window.showModal = (title, message, isSuccess = false) => {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center transform transition-all duration-300 scale-100">
                    ${isSuccess 
                        ? '<svg class="w-12 h-12 text-green-500 mx-auto mb-4 animate-scaleIn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                        : '<svg class="w-12 h-12 text-red-500 mx-auto mb-4 animate-scaleIn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                    }
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button id="close-message" class="bg-cyan-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Close</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('close-message').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        };

        // Initialize Firebase
        const initFirebase = async () => {
            try {
                // setLogLevel('debug');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                     // Still initialize authentication for a user ID even if config is absent
                } else {
                    window.firebaseApp = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.firebaseApp);
                    window.auth = getAuth(window.firebaseApp);

                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                    window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                }
                console.log("Firebase Auth/ID initialized. User ID:", window.userId || 'N/A');

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        };

        // Call initialization
        initFirebase();
    </script>
    <style>
        /* Custom styles for the vertical progress bar line */
        .step-line {
            position: absolute;
            left: 17px;
            top: 40px;
            bottom: -25px;
            width: 4px;
            background-color: #e5e7eb;
            z-index: 0;
            transition: all 0.4s ease;
        }

        /* The active line overlay */
        .step-line-active {
            position: absolute;
            left: 17px;
            top: 40px;
            width: 4px;
            background-color: #06b6d4;
            z-index: 1;
            transition: height 0.4s ease;
            height: 0;
        }

        /* Hide the progress bar on small screens */
        @media (max-width: 768px) {
            #progress-bar {
                display: none;
            }
        }
        
        /* Font and general styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Style for the active progress circle */
        .step-circle {
            transition: all 0.3s ease;
        }

        /* Keyframe animation for green tick */
        @keyframes scaleIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-scaleIn {
            animation: scaleIn 0.3s ease-out forwards;
        }
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeUp {
            animation: fadeUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .delay-200 { animation-delay: 0.2s; }
        .delay-400 { animation-delay: 0.4s; }
        .delay-600 { animation-delay: 0.6s; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen bg-gray-50 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
                Mind Your Minors - Book Checkout
            </h1>
            <p class="text-gray-500 mt-1">Block 6 Book | Price: <span id="base-price">â‚¹500.00</span></p>
        </header>

        <div class="md:flex md:space-x-12">
            
            <!-- 1. Vertical Progress Bar (Sticky Sidebar) - MD+ screens only -->
            <div id="progress-bar" class="md:w-1/3 relative hidden md:block">
                <div class="sticky top-8 pt-4">
                    <h2 class="text-lg font-semibold text-gray-700 mb-6">Your Progress</h2>
                    
                    <!-- Vertical Line Tracks -->
                    <div class="step-line"></div>
                    <div id="active-line" class="step-line-active"></div>

                    <!-- Step Items Container -->
                    <div id="step-container" class="space-y-6">
                        
                        <!-- Step 1 -->
                        <div data-target="shipping-step" class="flex items-start step-item relative z-10" id="step-1">
                            <div class="step-circle w-9 h-9 flex items-center justify-center rounded-full bg-cyan-500 text-white shadow-lg mr-4">
                                1
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Details & Discount</h3>
                                <p class="text-sm text-gray-500">Info and Coupon</p>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div data-target="payment-step" class="flex items-start step-item relative z-10" id="step-2">
                            <div class="step-circle w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-700 mr-4">
                                2
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Payment & Receipt</h3>
                                <p class="text-sm text-gray-500">Nayapay Transfer</p>
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div data-target="review-step" class="flex items-start step-item relative z-10" id="step-3">
                            <div class="step-circle w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-700 mr-4">
                                3
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900">Confirm Order</h3>
                                <p class="text-sm text-gray-500">Final Confirmation</p>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- 2. Checkout Content (Wrapped in Form for Submission) -->
            <form id="checkout-form" 
                  action="https://formsubmit.co/hasnainmughal4200@example.com" 
                  method="POST" 
                  enctype="multipart/form-data" 
                  class="md:w-2/3 space-y-12">

                <!-- HIDDEN FIELDS FOR FORMSUBMIT CONFIG -->
                <!-- Subject line for the email -->
                <input type="hidden" name="_subject" id="formSubmitSubject" value="NEW MYM Order #">
                <!-- Disables CAPTCHA (optional, but convenient for testing) -->
                <input type="hidden" name="_captcha" value="false">
                <!-- Redirect link (simulated by JS modal since external redirect is not possible here) -->
                <input type="hidden" name="_next" value="">
                
                <!-- HIDDEN FIELDS FOR DYNAMIC ORDER DATA -->
                <input type="hidden" name="Order Number" id="hiddenOrderNumber" value="">
                <input type="hidden" name="Total Amount Paid" id="hiddenTotalAmount" value="">
                <input type="hidden" name="Book Name" value="Mind Your Minors - Block 6 Book">
                <input type="hidden" name="Base Price" value="500">
                <input type="hidden" name="Coupon Used" id="hiddenCouponUsed" value="No">


                <!-- Step 1: Details & Discount Section -->
                <section id="shipping-step" class="step-section p-6 bg-white rounded-xl shadow-lg border border-cyan-100">
                    <h2 class="text-2xl font-bold text-cyan-700 mb-6 border-b pb-3">1. Student Details & Shipping</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="First Name" id="firstName" placeholder="First Name" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                            <input type="text" name="Last Name" id="lastName" placeholder="Last Name" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                        </div>
                        
                        <!-- College Selection (Search/Select) -->
                        <div>
                            <label for="collegeSelect" class="block text-sm font-medium text-gray-700 mb-1">Select College</label>
                            <input list="collegesList" name="College" id="collegeSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Search or select your college..." required>
                            <datalist id="collegesList">
                                <!-- Populated by JS -->
                            </datalist>
                        </div>
                        
                        <!-- Conditional Fields: AIMC ONLY -->
                        <div id="aimc-fields" class="space-y-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                            <label class="block text-lg font-bold text-yellow-800">Allama Iqbal Medical College Discount</label>
                            <input type="text" name="AIMC Roll Number" id="rollNumber" placeholder="AIMC Roll Number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            
                            <div class="flex items-center space-x-2">
                                <input type="text" name="Coupon Code Entered" id="couponCode" placeholder="Enter Coupon Code" value="" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 uppercase">
                                <button type="button" id="applyCouponBtn" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition duration-150">Apply</button>
                                <div id="couponStatus" class="w-8 h-8 flex items-center justify-center">
                                    <!-- Green tick/cross icon -->
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        <h3 class="font-bold text-gray-900 pt-2 border-t mt-4">Shipping Address</h3>
                        <input type="text" name="Street Address" id="streetAddress" placeholder="Street Address" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" name="City" id="city" placeholder="City" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                            <input type="text" name="Province" id="province" placeholder="State / Province" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                            <input type="text" name="Zip Code" id="zipCode" placeholder="Zip Code" required class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                        </div>
                        <input type="tel" name="Contact Number" id="contactNumber" placeholder="Contact Number (e.g., 03091234567)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
                    </div>
                </section>

                <!-- Step 2: Payment Details Section -->
                <section id="payment-step" class="step-section p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-cyan-700 mb-6 border-b pb-3">2. Make Payment & Upload Receipt</h2>
                    
                    <!-- Payment Instructions -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-lg">
                        <p class="text-sm text-blue-700 font-semibold mb-2">Please transfer the total amount shown below to:</p>
                        <p class="text-lg font-bold text-gray-900">
                            Nayapay: Muhammad Hasnain<br>
                            Account No: 03096554421
                        </p>
                    </div>

                    <!-- Receipt Upload -->
                    <div class="space-y-4">
                        <label for="receiptUpload" class="block text-gray-700 font-medium">Upload Payment Receipt</label>
                        <div class="flex items-center space-x-4 p-4 border border-gray-300 rounded-lg">
                            <!-- IMPORTANT: Name MUST be attachment for FormSubmit to include file -->
                            <input type="file" name="attachment" id="receiptUpload" accept="image/*, application/pdf" class="flex-grow focus:ring-2 focus:ring-cyan-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100" required>
                            <div id="receiptStatus" class="w-8 h-8 flex items-center justify-center">
                                <!-- Green tick/cross icon -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Step 3: Order Review & Placement Section -->
                <section id="review-step" class="step-section p-6 bg-white rounded-xl shadow-lg mb-10">
                    <h2 class="text-2xl font-bold text-cyan-700 mb-6 border-b pb-3">3. Final Order Review</h2>
                    
                    <!-- Dynamic Order Summary -->
                    <div class="space-y-3 mb-6 text-gray-700">
                        <div class="flex justify-between pb-2">
                            <span>Mind Your Minors - Block 6 Book</span>
                            <span id="initial-price" class="font-semibold">â‚¹500.00</span>
                        </div>
                        <div id="discount-row" class="flex justify-between pb-2 text-green-600 hidden">
                            <span>Coupon Discount (AIMC28)</span>
                            <span id="discount-amount" class="font-semibold">-â‚¹100.00</span>
                        </div>
                        <div class="flex justify-between border-t border-dashed pt-3">
                            <span class="text-xl font-extrabold text-gray-900">Total Amount Payable</span>
                            <span id="final-amount" class="text-xl font-extrabold text-cyan-600">â‚¹500.00</span>
                        </div>
                    </div>

                    <!-- Unique Order Summary - Hidden until receipt is uploaded -->
                    <div id="final-summary-box" class="hidden border border-green-300 bg-green-50 p-4 rounded-lg mb-6 animate-scaleIn">
                         <h3 class="font-bold text-green-800 mb-2">Order Details Confirmation</h3>
                         <div class="flex justify-between text-sm text-green-700">
                             <span>Your Unique Order No:</span>
                             <span id="order-number-display" class="font-extrabold">-- Pending --</span>
                         </div>
                    </div>

                    <!-- Terms Checkbox -->
                    <div class="flex items-start mb-6">
                        <input type="checkbox" id="terms" required class="mt-1 mr-3 rounded text-cyan-600 focus:ring-cyan-500 border-gray-300">
                        <label for="terms" class="text-sm text-gray-600">I agree to the <a href="#" class="text-cyan-600 hover:text-cyan-800 font-medium">Terms of Service</a> and confirm all information and payment are correct.</label>
                    </div>

                    <!-- Final Button - Changed to type="submit" -->
                    <button id="place-order-btn" type="submit" class="w-full py-4 bg-cyan-600 text-white font-extrabold text-lg rounded-xl shadow-xl hover:bg-cyan-700 transition duration-200 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-cyan-500 focus:ring-opacity-50 disabled:opacity-50" disabled>
                        Confirm Order
                    </button>
                </section>
                
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONSTANTS & STATE ---
        const BOOK_PRICE = 500;
        const COUPON_CODE = 'AIMC28';
        const DISCOUNT_AMOUNT = 100;
        let currentPrice = BOOK_PRICE;
        let isCouponValid = false;
        let isReceiptUploaded = false;
        let finalOrderNumber = '';
        
        // List of Colleges in Punjab (Pakistan context, based on AIMC and contact number)
        const COLLEGES = [
            "Allama Iqbal Medical College (AIMC)",
            "King Edward Medical University (KEMU)",
            "Fatima Jinnah Medical University (FJMU)",
            "Services Institute of Medical Sciences (SIMS)",
            "Rawalpindi Medical University (RMU)",
            "Nishtar Medical University (NMU)",
            "Quaid-e-Azam Medical College (QAMC)",
            "Sialkot Medical College",
            "Lahore Medical and Dental College (LMDC)",
            "CMH Lahore Medical College"
        ];
        
        // --- DOM Elements ---
        const stepSections = document.querySelectorAll('.step-section');
        const stepItems = document.querySelectorAll('.step-item');
        const activeLine = document.getElementById('active-line');
        const stepContainer = document.getElementById('step-container');
        const collegeSelect = document.getElementById('collegeSelect');
        const collegeDatalist = document.getElementById('collegesList');
        const aimcFields = document.getElementById('aimc-fields');
        const couponCodeInput = document.getElementById('couponCode');
        const applyCouponBtn = document.getElementById('applyCouponBtn');
        const couponStatus = document.getElementById('couponStatus');
        const receiptUpload = document.getElementById('receiptUpload');
        const receiptStatus = document.getElementById('receiptStatus');
        const discountRow = document.getElementById('discount-row');
        const finalAmountDisplay = document.getElementById('final-amount');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const finalSummaryBox = document.getElementById('final-summary-box');
        const orderNumberDisplay = document.getElementById('order-number-display');
        const checkoutForm = document.getElementById('checkout-form');

        // Hidden FormSubmit fields
        const hiddenOrderNumber = document.getElementById('hiddenOrderNumber');
        const hiddenTotalAmount = document.getElementById('hiddenTotalAmount');
        const hiddenCouponUsed = document.getElementById('hiddenCouponUsed');
        const formSubmitSubject = document.getElementById('formSubmitSubject');


        // --- PROGRESS BAR LOGIC (Intersection Observer) ---

        /** Updates the vertical line's height based on the current active step. */
        function updateLineHeight(currentStepItem) {
            const containerRect = stepContainer.getBoundingClientRect();
            const stepRect = currentStepItem.getBoundingClientRect();
            const height = stepRect.top - containerRect.top + 40; 
            
            const maxStepHeight = stepItems[stepItems.length - 1].offsetTop + 40;
            activeLine.style.height = `${Math.min(height, maxStepHeight)}px`;
        }

        /** Sets the active state on the progress bar item. */
        function updateProgress(targetId) {
            let currentStepIndex = -1;

            stepItems.forEach((item, index) => {
                const isMatch = item.getAttribute('data-target') === targetId;

                if (isMatch) currentStepIndex = index;
            });
            
            // Highlight steps
            for (let i = 0; i < stepItems.length; i++) {
                const circle = stepItems[i].querySelector('.step-circle');
                if (i <= currentStepIndex) {
                    // Completed or Current active step
                    circle.classList.add('bg-cyan-500', 'text-white');
                    circle.classList.remove('bg-gray-300', 'text-gray-700');
                    if (i === currentStepIndex) {
                        circle.classList.add('shadow-lg');
                    } else {
                         circle.classList.remove('shadow-lg');
                    }
                } else {
                    // Future steps
                    circle.classList.add('bg-gray-300', 'text-gray-700');
                    circle.classList.remove('bg-cyan-500', 'text-white', 'shadow-lg');
                }
            }

            const activeItem = currentStepIndex !== -1 ? stepItems[currentStepIndex] : stepItems[0];
            if (activeItem) {
                updateLineHeight(activeItem);
            }
        }

        const observerOptions = {
            root: null,
            rootMargin: '0px 0px -50% 0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    updateProgress(entry.target.id);
                }
            });
        }, observerOptions);

        // --- INITIALIZATION ---
        
        // 1. Populate Datalist
        COLLEGES.forEach(college => {
            const option = document.createElement('option');
            option.value = college;
            collegeDatalist.appendChild(option);
        });

        // 2. Start observing sections on desktop
        if (window.innerWidth >= 768) {
            stepSections.forEach(section => observer.observe(section));
            updateProgress('shipping-step'); // Initial set
        }

        // 3. Set Initial Price
        updateOrderSummary();
        
        // --- EVENT HANDLERS ---
        
        /** Checks if all required fields in Step 1 and 2 are filled and enables the final button. */
        function checkFormValidity() {
            // Check HTML5 validity for all form fields
            const formValid = checkoutForm.checkValidity();
            const termsChecked = document.getElementById('terms').checked;

            // Only enable the final button if details are valid, receipt is confirmed, and terms are checked
            if (formValid && isReceiptUploaded && termsChecked) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.classList.remove('bg-gray-400');
                placeOrderBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
            } else {
                placeOrderBtn.disabled = true;
                placeOrderBtn.classList.add('bg-gray-400');
                placeOrderBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-700');
            }
        }
        
        /** Shows/hides AIMC fields and removes the coupon if the college changes. */
        function handleCollegeChange() {
            const selectedCollege = collegeSelect.value;
            const isAIMC = selectedCollege.includes("Allama Iqbal Medical College");

            if (isAIMC) {
                aimcFields.classList.remove('hidden');
            } else {
                aimcFields.classList.add('hidden');
                // Reset coupon if user switches away
                isCouponValid = false;
                updateOrderSummary();
                couponStatus.innerHTML = '';
            }
            checkFormValidity();
        }
        collegeSelect.addEventListener('input', handleCollegeChange);
        collegeSelect.addEventListener('change', handleCollegeChange);
        checkoutForm.addEventListener('input', checkFormValidity); // Listen to changes across all fields
        document.getElementById('terms').addEventListener('change', checkFormValidity);


        /** Handles coupon application and price update. */
        function applyCoupon() {
            const enteredCode = couponCodeInput.value.toUpperCase().trim();
            
            if (enteredCode === COUPON_CODE) {
                isCouponValid = true;
                couponStatus.innerHTML = `
                    <svg class="w-6 h-6 text-green-500 animate-scaleIn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                `;
                updateOrderSummary();
            } else {
                isCouponValid = false;
                couponStatus.innerHTML = `
                    <svg class="w-6 h-6 text-red-500 animate-scaleIn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                `;
                updateOrderSummary();
                window.showModal('Invalid Coupon', `The code you entered is not valid. Please ensure it is "${COUPON_CODE}".`, false);
            }
        }
        applyCouponBtn.addEventListener('click', applyCoupon);

        /** Updates the summary and hidden fields based on coupon status. */
        function updateOrderSummary() {
            currentPrice = BOOK_PRICE;

            if (isCouponValid) {
                currentPrice -= DISCOUNT_AMOUNT;
                discountRow.classList.remove('hidden');
                hiddenCouponUsed.value = `Yes (${COUPON_CODE})`;
            } else {
                discountRow.classList.add('hidden');
                hiddenCouponUsed.value = 'No';
            }

            // Update UI
            finalAmountDisplay.textContent = `â‚¹${currentPrice.toFixed(2)}`;
            
            // Update Hidden fields for FormSubmit
            hiddenTotalAmount.value = currentPrice.toFixed(2);
            
            if (isReceiptUploaded && finalOrderNumber) {
                finalSummaryBox.classList.remove('hidden');
                orderNumberDisplay.textContent = finalOrderNumber;
                hiddenOrderNumber.value = finalOrderNumber;
                formSubmitSubject.value = `NEW MYM Order #${finalOrderNumber}`;
            } else {
                finalSummaryBox.classList.add('hidden');
                orderNumberDisplay.textContent = '-- Pending --';
                hiddenOrderNumber.value = '';
                formSubmitSubject.value = 'NEW MYM Order #';
            }
            
            checkFormValidity();
        }
        
        /** Handles the receipt file upload simulation and confirmation. */
        receiptUpload.addEventListener('change', () => {
            if (receiptUpload.files.length > 0) {
                isReceiptUploaded = true;
                const receiptFileName = receiptUpload.files[0].name;

                // Green tick animation
                receiptStatus.innerHTML = `
                    <svg class="w-8 h-8 text-green-500 animate-scaleIn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                `;
                
                // Immediately generate the unique order number on confirmation
                if (!finalOrderNumber) {
                    finalOrderNumber = `MYM-${Date.now().toString().slice(-6)}${Math.floor(Math.random() * 900) + 100}`;
                }
                
                updateOrderSummary();
                
                // Show a temporary message indicating file confirmation
                window.showModal(
                    'Receipt Uploaded', 
                    `Receipt "${receiptFileName}" confirmed. Your unique Order No. (${finalOrderNumber}) has been generated. You can now finalize your order.`,
                    true
                );

            } else {
                isReceiptUploaded = false;
                finalOrderNumber = ''; // Reset order number if file is removed
                receiptStatus.innerHTML = '';
                updateOrderSummary();
            }
        });


        /** Intercepts form submission for final visual confirmation before native submission. */
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent native submission temporarily for visual feedback

            // Ensure final validation passes
            if (!checkoutForm.checkValidity() || !document.getElementById('terms').checked || !isReceiptUploaded) {
                // If validation fails (shouldn't happen if button is enabled, but good to check)
                window.showModal('Validation Error', 'Please fill out all required fields, upload the receipt, and agree to the terms.', false);
                return;
            }

            // 1. Show Thank You Page Modal (Simulates redirect after successful FormSubmit email send)
            const thankYouModal = document.createElement('div');
            thankYouModal.className = 'fixed inset-0 bg-white flex items-center justify-center p-4 z-50 transition-opacity duration-700 ease-in';
            thankYouModal.style.opacity = '0'; // Start invisible for fade-in

            thankYouModal.innerHTML = `
                <div class="max-w-xl w-full text-center">
                    <svg class="w-20 h-20 text-green-500 mx-auto mb-6 animate-scaleIn" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-4 animate-fadeUp">Thank You For Your Order!</h1>
                    <p class="text-lg text-gray-600 mb-8 animate-fadeUp delay-200">Your order has been confirmed and details are being processed.</p>
                    
                    <div class="bg-gray-100 p-6 rounded-xl shadow-inner inline-block text-left animate-fadeUp delay-400">
                        <h3 class="text-xl font-bold text-cyan-700 mb-3">Order Summary</h3>
                        <p class="text-gray-700 mb-1">Order Number: <span class="font-extrabold text-gray-900">${finalOrderNumber}</span></p>
                        <p class="text-gray-700">Total Charged: <span class="font-extrabold text-cyan-600">â‚¹${currentPrice.toFixed(2)}</span></p>
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-6 animate-fadeUp delay-600">The order details and receipt file have been submitted via email to: hasnainmughal4200@example.com (FormSubmit Simulation)</p>
                </div>
            `;
            
            // Replace body content with the modal for the redirection effect
            document.body.innerHTML = '';
            document.body.appendChild(thankYouModal);
            
            // Trigger the fade-in
            setTimeout(() => {
                thankYouModal.style.opacity = '1';
                // In a real browser environment, the form would submit and redirect here.
                // Since this environment prevents external redirects, we just show the final state.
                console.log(`--- FORM SUBMISSION SIMULATION ---`);
                console.log(`Data (including receipt file) SENT to FormSubmit address: hasnainmughal4200@example.com`);
                console.log(`Order Number: ${finalOrderNumber}, Amount: â‚¹${currentPrice.toFixed(2)}`);
                console.log(`-----------------------------------`);
            }, 50);

            // Note: If you run this file outside this environment (e.g., on your local machine), 
            // you would typically remove the e.preventDefault() and the JS modal logic, 
            // allowing the native form submission to handle the POST and redirection to FormSubmit's success page.
        });
    });
</script>

</body>
</html>


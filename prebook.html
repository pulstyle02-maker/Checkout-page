<script>
(async () => {
  // --- DYNAMIC FIREBASE IMPORT (WORKS EVERYWHERE) ---
  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
  const { getAuth, signInAnonymously, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
  const { getFirestore, addDoc, collection, setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

  // --- Global Setup ---
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  setLogLevel('debug');

  let userId = null;
  let isAuthReady = false;
  let currentStep = 1;
  const totalSteps = 5;
  const preOrderDetails = {};

  async function initAuth() {
    try {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
      userId = auth.currentUser.uid;
    } catch (e) {
      console.error(e);
      userId = auth.currentUser?.uid || crypto.randomUUID();
      alertUser("Database connection issue â€” pre-order may not save.");
    } finally {
      isAuthReady = true;
    }
  }
  initAuth();

  // --- Utility Functions ---
  function alertUser(msg) {
    const box = document.getElementById('messageBox');
    box.innerText = msg;
    box.classList.add('show');
    setTimeout(() => box.classList.remove('show'), 4000);
  }

  function updateProgress() {
    const progress = document.getElementById('progress');
    const circles = document.querySelectorAll('.circle');
    circles.forEach((c, i) => c.classList.toggle('active', i < currentStep));
    progress.style.width = ((currentStep - 1) / (totalSteps - 1)) * 100 + '%';
  }

  window.toggleContactInput = (method) => {
    const emailField = document.getElementById('emailField');
    const emailInput = document.getElementById('email');
    const whatsappField = document.getElementById('whatsappField');
    const contactInput = document.getElementById('contact');

    emailField.classList.remove('visible');
    whatsappField.classList.remove('visible');
    emailInput.removeAttribute('required');
    contactInput.removeAttribute('required');

    if (method === 'Email') {
      emailField.classList.add('visible');
      emailInput.required = true;
    } else if (method === 'WhatsApp') {
      whatsappField.classList.add('visible');
      contactInput.required = true;
    }
  };

  function displayPreOrderDetails() {
    const d = preOrderDetails;
    const div = document.getElementById('preOrderDetails');
    div.innerHTML = `
      <p><strong>Name:</strong> ${d.fullName}</p>
      <p><strong>College:</strong> ${d.college}</p>
      <p><strong>Notification Method:</strong> ${d.notificationMethod}</p>
      ${d.notificationMethod === 'Email' ? `<p><strong>Email:</strong> ${d.email}</p>` : `<p><strong>WhatsApp:</strong> ${d.contact}</p>`}
    `;
  }

  async function addPreOrderToFirestore(data) {
    if (!isAuthReady || !userId) return null;
    const ref = collection(db, `artifacts/${appId}/users/${userId}/preOrders`);
    try {
      const doc = await addDoc(ref, data);
      return doc.id;
    } catch (e) {
      alertUser("Database error. Try again.");
      console.error(e);
      return null;
    }
  }

  async function sendEmailNotification(docId) {
    const data = {
      _subject: `MIND YOUR MINORS Pre-Order (ID: ${docId})`,
      _template: 'table',
      _cc: 'modmedicalis@gmail.com',
      Full_Name: preOrderDetails.fullName,
      College: preOrderDetails.college,
      Notification_Method: preOrderDetails.notificationMethod,
      Contact_Number: preOrderDetails.contact || 'N/A',
      Email_Address: preOrderDetails.email || 'N/A',
      Discount: '15%',
      Timestamp: new Date().toLocaleString(),
    };
    await fetch("https://formsubmit.co/modmedicalis@gmail.com", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(data)
    }).catch(console.error);
  }

  function prevStep() {
    if (currentStep > 1) {
      document.querySelector(`.step-${currentStep}`).classList.add('hidden');
      currentStep--;
      updateProgress();
      document.querySelector(`.step-${currentStep}`).classList.remove('hidden');
    }
  }

  async function nextStep() {
    let valid = true;
    const cur = document.querySelector(`.step-${currentStep}`);
    if (currentStep === 1) {
      const name = document.getElementById('fullName').value.trim();
      if (!name) return alertUser("Enter full name."), valid = false;
      preOrderDetails.fullName = name;
    } else if (currentStep === 2) {
      const college = document.getElementById('college').value;
      if (!college) return alertUser("Select your college."), valid = false;
      preOrderDetails.college = college;
    } else if (currentStep === 3) {
      const method = document.getElementById('notificationMethod').value;
      const email = document.getElementById('email').value.trim();
      const contact = document.getElementById('contact').value.trim();
      if (!method) return alertUser("Select notification method."), valid = false;
      preOrderDetails.notificationMethod = method;
      preOrderDetails.email = method === 'Email' ? email : '';
      preOrderDetails.contact = method === 'WhatsApp' ? contact : '';
    } else if (currentStep === 4) {
      if (!isAuthReady) return alertUser("Connecting... try again."), valid = false;
      const final = {
        ...preOrderDetails,
        book: 'MIND YOUR MINORS BLOCK 6',
        discount: '15%',
        status: 'Confirmed',
        timestamp: new Date().toISOString(),
      };
      const id = await addPreOrderToFirestore(final);
      if (id) {
        document.getElementById('orderNumber').innerText = id;
        document.getElementById('confirmationContact').innerText =
          preOrderDetails.notificationMethod === 'Email'
            ? `Email at ${preOrderDetails.email}`
            : `WhatsApp at ${preOrderDetails.contact}`;
        sendEmailNotification(id);
      } else valid = false;
    }

    if (valid && currentStep < totalSteps) {
      cur.classList.add('hidden');
      currentStep++;
      updateProgress();
      document.querySelector(`.step-${currentStep}`).classList.remove('hidden');
      if (currentStep === 4) displayPreOrderDetails();
    }
  }

  document.querySelectorAll('.js-next').forEach(b => b.addEventListener('click', nextStep));
  document.querySelectorAll('.js-prev').forEach(b => b.addEventListener('click', prevStep));
  updateProgress();
})();
</script>

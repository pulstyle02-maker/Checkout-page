<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suturing Workshop Registration - Professional Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Define a custom font stack for a cleaner, modern look */
  body {
    font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }
  /* Custom styles for the slot buttons */
  .slot-btn {
    transition: all 0.2s ease-in-out;
    border: 1px solid #e5e7eb; /* Subtle gray border */
    position: relative;
    overflow: hidden;
  }
  .slot-btn:hover:not(:disabled) {
    border-color: #3b82f6; /* Subtle blue on hover */
    background-color: #f0f4ff; /* Very light blue */
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }
  .slot-btn.selected {
    border-color: #1d4ed8; /* Deep blue border */
    background-color: #dbeafe; /* Lightest blue fill */
    color: #1d4ed8; /* Deep blue text */
    font-weight: 600;
  }
  .slot-btn:disabled {
    cursor: not-allowed;
    background-color: #f9fafb; /* Lighter gray background */
    color: #9ca3af; /* Light gray text */
    border-color: #f3f4f6;
    text-decoration: line-through;
    opacity: 0.8;
  }
  /* Style for inputs */
  .pro-input {
    border: 1px solid #e5e7eb;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .pro-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
  }
</style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

<div class="bg-white shadow-xl border border-gray-100 rounded-xl p-8 w-full max-w-lg">
  
  <header class="text-center mb-8 border-b pb-4">
    <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Suturing Workshop Enrollment</h1>
    <p class="text-md text-gray-500 mt-1">Skills Lab, Community Medicine • October 16, 2025</p>
  </header>
  
  <div id="slotInfo" class="bg-white border-2 border-gray-200 p-4 rounded-lg mb-8 shadow-sm text-sm space-y-1">
    <p class="font-semibold text-gray-700 uppercase tracking-wider mb-1">Live Slot Availability</p>
    </div>

  <form id="regForm" class="space-y-6">
    
    <div>
      <label for="batch" class="block text-sm font-medium text-gray-700 mb-2">1. Select Workshop Batch</label>
      <select id="batch" required 
        class="pro-input rounded-md p-3 w-full appearance-none bg-white text-gray-800 transition duration-150 ease-in-out focus:ring-blue-500">
        <option value="" disabled selected>Select an option...</option>
        <option value="A">Batch A</option>
        <option value="D">Batch D</option>
      </select>
    </div>

    <div id="timeSlotContainer" class="hidden">
      <label class="block text-sm font-medium text-gray-700 mb-2">2. Choose Time Slot</label>
      <div id="slotButtons" class="grid grid-cols-2 gap-3">
        </div>
      <input type="hidden" id="slotTime" name="slotTime" required />
    </div>

    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-2">3. Personal Details</label>
      <input id="name" placeholder="Full Name" required 
        class="pro-input p-3 rounded-md w-full mb-3 focus:ring-blue-500" />
      <input id="rollNo" placeholder="Roll No" required 
        class="pro-input p-3 rounded-md w-full focus:ring-blue-500" />
    </div>

    <div class="text-sm bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md shadow-sm">
      <p class="font-bold text-blue-800 mb-1">Fee: Rs 150 (Required)</p>
      <p class="text-blue-700">Please send payment to the following accounts before submission:</p>
      <ul class="list-disc ml-5 mt-2 text-gray-700 space-y-0.5">
        <li>**Hamza Masood Gondal** (Easypaisa): <code class="font-mono text-gray-900">0332-8483843</code></li>
        <li>**Mahrukh Nadeem** (JazzCash): <code class="font-mono text-gray-900">0318-6967013</code></li>
      </ul>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">4. Upload Proof of Payment</label>
      <input type="file" name="attachment" required 
        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer transition duration-150" />
    </div>

    <input type="hidden" name="_subject" value="Suturing Workshop Payment Slip" />
    <input type="hidden" name="_next" value="https://example.com/thankyou.html" />
    <input type="hidden" name="_captcha" value="false" />
    <input type="hidden" name="_template" value="table" />
    <input type="hidden" name="_autoresponse"
           value="Thank you! Your registration for Suturing Workshop (16 Oct 2025) is confirmed. We will verify payment shortly." />

    <button type="submit"
      class="bg-gray-900 text-white w-full p-3 rounded-md font-semibold text-lg hover:bg-blue-600 transition duration-200 shadow-lg shadow-gray-200 disabled:opacity-50 disabled:hover:bg-gray-900"
      id="submitButton">
      Submit Registration
    </button>
  </form>

  <p id="msg" class="text-center text-sm mt-6 font-medium p-3 rounded-md"></p>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxD6QGfnzhGeg7RkxCLONqyPR-QGBzBn6DHPB6YaTZgDma_CwQc7c88-OIHDjlyq9RY/exec";
const FORM_EMAIL_URL = "https://formsubmit.co/hasnainmughal4200@gmail.com";
let slotsData = [];

// --- UI Element References ---
const batchSelect = document.getElementById("batch");
const slotContainer = document.getElementById("timeSlotContainer");
const slotButtonsDiv = document.getElementById("slotButtons");
const slotTimeInput = document.getElementById("slotTime");
const slotInfoDiv = document.getElementById("slotInfo");
const regForm = document.getElementById("regForm");
const msgElement = document.getElementById("msg");

// --- Core Functions ---

/**
 * Fetches the latest slot data from the Google Script.
 */
async function loadSlots() {
  try {
    const res = await fetch(API_URL);
    slotsData = await res.json();
    displaySlotSnapshot();
    if (batchSelect.value) {
      populateSlotButtons(batchSelect.value);
    }
  } catch (err) {
    console.error("Error loading slots:", err);
    slotInfoDiv.innerHTML = '<p class="text-red-500 font-medium">❌ Failed to load live slot data. Please check your connection.</p>';
  }
}

/**
 * Displays a summary of all slot availability with professional styling.
 */
function displaySlotSnapshot() {
    // Clear and set the professional header
    slotInfoDiv.innerHTML = '<p class="font-semibold text-gray-700 uppercase tracking-wider mb-1">Live Slot Availability</p>';
    
    slotsData.forEach(s => {
      const line = document.createElement("div");
      // Use clean, professional color coding
      const statusClass = s.remaining > 0 ? "text-green-600 font-medium" : "text-red-500 font-medium line-through";
      
      line.innerHTML = `<span class="${statusClass}">Batch ${s.batch} | ${s.slotTime}</span> &rarr; ${s.remaining} slots remaining`;
      line.className = "text-gray-600";
      slotInfoDiv.appendChild(line);
    });
}

/**
 * Creates dynamic buttons for time slots based on the selected batch.
 * @param {string} batch - The selected batch ('A' or 'D').
 */
function populateSlotButtons(batch) {
  const selectedSlot = slotTimeInput.value;
  slotButtonsDiv.innerHTML = ''; // Clear existing buttons
  slotContainer.classList.remove('hidden'); // Show the container

  const batchSlots = slotsData
    .filter(s => s.batch === batch)
    .sort((a, b) => a.slotTime.localeCompare(b.slotTime));

  if (batchSlots.length === 0) {
    slotButtonsDiv.innerHTML = '<p class="text-red-500 col-span-2">No time slots configured for this batch.</p>';
    return;
  }

  batchSlots.forEach(s => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.value = s.slotTime;
    
    const remainingText = s.remaining > 0 ? ` (${s.remaining} left)` : ' (SOLD OUT)';
    btn.innerHTML = `
      <div class="text-lg font-medium">${s.slotTime}</div>
      <div class="text-xs text-gray-500">${remainingText}</div>
    `;
    
    btn.className = 'slot-btn p-3 rounded-md text-gray-800 text-center focus:outline-none';
    
    // Set availability
    if (s.remaining <= 0) {
      btn.disabled = true;
      btn.innerHTML = `
        <div class="text-lg font-medium">${s.slotTime}</div>
        <div class="text-xs text-red-500">SOLD OUT</div>
      `;
    }

    // Set 'selected' state if applicable
    if (s.slotTime === selectedSlot && !btn.disabled) {
        btn.classList.add('selected');
        slotTimeInput.value = s.slotTime;
    }

    // Click handler for selection
    btn.addEventListener('click', () => {
      // Deselect all others
      document.querySelectorAll('#slotButtons .slot-btn').forEach(b => b.classList.remove('selected'));
      // Select current
      btn.classList.add('selected');
      // Update hidden input
      slotTimeInput.value = btn.value;
    });

    slotButtonsDiv.appendChild(btn);
  });
}

// --- Event Listeners ---

// 1. Batch Change: Updates the dynamic slot buttons
batchSelect.addEventListener("change", e => {
  const batch = e.target.value;
  slotTimeInput.value = ''; 
  if (batch) {
    populateSlotButtons(batch);
  } else {
    slotContainer.classList.add('hidden');
    slotButtonsDiv.innerHTML = '';
  }
});


// 2. Form Submission (Integration remains the same)
regForm.addEventListener("submit", async e => {
  e.preventDefault();
  
  if (!slotTimeInput.value) {
    msgElement.textContent = "❌ Please select a time slot using the buttons.";
    msgElement.className = "text-red-600 font-medium bg-red-50";
    return;
  }

  const submitBtn = document.getElementById('submitButton');
  submitBtn.disabled = true;
  submitBtn.textContent = "Processing... Please Wait";
  msgElement.textContent = "";

  const data = {
    name: document.getElementById("name").value,
    rollNo: document.getElementById("rollNo").value,
    batch: batchSelect.value,
    slotTime: slotTimeInput.value,
    paymentLink: "Uploaded via FormSubmit" 
  };

  try {
    // 1. Send registration to Web App
    const reservePromise = fetch(API_URL, { 
      method: "POST", 
      body: JSON.stringify(data),
      headers: {'Content-Type': 'application/json'}
    });
    
    // 2. Send payment slip via FormSubmit
    const fd = new FormData(e.target);
    const formSubmitPromise = fetch(FORM_EMAIL_URL, { method: "POST", body: fd });

    await Promise.all([reservePromise, formSubmitPromise]);

    msgElement.textContent = "✅ Success! Your slot is confirmed. Check your email for a response.";
    msgElement.className = "text-green-700 font-medium bg-green-50";

    // Reset the UI
    regForm.reset();
    slotTimeInput.value = '';
    slotContainer.classList.add('hidden');
    await loadSlots(); 

  } catch (err) {
    console.error("Submission Error:", err);
    msgElement.textContent = "❌ Error! Registration failed. Please try again.";
    msgElement.className = "text-red-600 font-medium bg-red-50";
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Registration";
  }
});

// --- Initialization ---
loadSlots();
</script>
</body>
</html>
